<?php class ModelExtensionModuleSalesagent extends Model{public function getsalesagents($data=array()){$sql="SELECT DISTINCT *, CONCAT(s.firstname, ' ', s.lastname) AS name FROM ".DB_PREFIX."salesagent s LEFT JOIN ".DB_PREFIX."salesagent_store ss ON (s.salesagent_id = ss.salesagent_id) WHERE s.status = 1 AND ss.store_id = '".(int)$this->config->get('config_store_id')."' ORDER BY s.firstname ASC";$query=$this->db->query($sql);return $query->rows;}public function getsalesagent(){$salesagent_id=0;if(isset($this->session->data['salesagent_id'])){if($this->isValidSalesAgent($this->session->data['salesagent_id'])){$salesagent_id=$this->session->data['salesagent_id'];}}if(!$salesagent_id&&$this->customer->isLogged()){$query=$this->db->query("SELECT * FROM ".DB_PREFIX."salesagent_customer WHERE customerid = '".(int)$this->customer->getId()."' LIMIT 1");if($query->num_rows){if($this->isValidSalesAgent($query->row['salesagent_id'])){$salesagent_id=$query->row['salesagent_id'];}}}return $salesagent_id;}public function saveSalesAgentForOrder($order_id,$customer_id){if($this->config->get("salesagentdebug_status")){$this->log->write("SalesAgent Saving Agent In Temp Order Model Function");}$this->removeTransactionSession($order_id);$salesagent_id=0;if(isset($this->session->data['salesagent_id'])){if($this->isValidSalesAgent($this->session->data['salesagent_id'])){$salesagent_id=$this->session->data['salesagent_id'];}}if(!$salesagent_id&&isset($_COOKIE['scode'])&&!isset($this->session->data['api_id'])){$uniqueid=$_COOKIE['scode'];$query=$this->db->query("SELECT * FROM ".DB_PREFIX."salesagent s LEFT JOIN ".DB_PREFIX."salesagent_store ss ON (s.salesagent_id = ss.salesagent_id) WHERE s.uniqueid = '".$this->db->escape($uniqueid)."' AND s.status = 1 AND ss.store_id = '".(int)$this->config->get('config_store_id')."'");if($query->num_rows){$salesagent_id=$query->row['salesagent_id'];}}if(!$salesagent_id&&$customer_id){if($this->config->get('salesagent_recurrsive')){$query=$this->db->query("SELECT * FROM ".DB_PREFIX."salesagent_customer WHERE customerid = '".(int)$customer_id."' LIMIT 1");if($query->num_rows){if($this->isValidSalesAgent($query->row['salesagent_id'])){$salesagent_id=$query->row['salesagent_id'];}}}}if($salesagent_id){if($this->config->get("salesagentdebug_status")){$this->log->write("SalesAgent Agent Found with id ".$salesagent_id." and order id ".$order_id);}$this->db->query("INSERT INTO ".DB_PREFIX."salesagent_temporder SET salesagent_id = '".(int)$salesagent_id."', order_id = '".(int)$order_id."'");}else{if($this->config->get("salesagentdebug_status")){$this->log->write("SalesAgent No Agent Found");}}}public function getSalesAgentForOrder($order_id){$query=$this->db->query("SELECT * FROM ".DB_PREFIX."salesagent_temporder WHERE order_id = '".(int)$order_id."' LIMIT 1");if($query->num_rows){return $query->row['salesagent_id'];}else{return 0;}}public function isValidSalesAgent($salesagent_id){$query=$this->db->query("SELECT * FROM ".DB_PREFIX."salesagent s LEFT JOIN ".DB_PREFIX."salesagent_store ss ON (s.salesagent_id = ss.salesagent_id) WHERE s.salesagent_id = '".(int)$salesagent_id."' AND s.status = 1 AND ss.store_id = '".(int)$this->config->get('config_store_id')."'");if($query->num_rows){return 1;}return 0;}public function addtransaction($order_id=0,$order_info=array()){if($this->config->get("salesagentdebug_status")){$this->log->write("SalesAgent In Add Transaction Model Function");}$this->session->data['salesagentemail']=array();$salesagent_id=$this->getSalesAgentForOrder($order_id);if($salesagent_id){$this->db->query("DELETE FROM ".DB_PREFIX."salesagent_transaction WHERE order_id = '".(int)$order_id."'");}if($order_info['customer_id']&&$salesagent_id){$this->db->query("DELETE FROM ".DB_PREFIX."salesagent_customer WHERE customerid = '".(int)$order_info['customer_id']."'");$this->db->query("INSERT INTO ".DB_PREFIX."salesagent_customer SET salesagent_id = '".(int)$salesagent_id."', customerid = '".(int)$order_info['customer_id']."'");}if($salesagent_id){$emails=array();$query=$this->db->query("SELECT * FROM ".DB_PREFIX."salesagent WHERE salesagent_id = '".(int)$salesagent_id."'")->row;if(isset($query['salesagent_id'])){$sub_total=$this->getSubTotal($order_id);if($this->config->get("salesagent_commissiontotal")){$total=$sub_total;}else{$total=$order_info['total'];}$salesagent_name=$query['firstname']." ".$query['lastname'];$commission=$query['commission'];if($order_info['customer_id']){$customer_group_based_commission=$this->getCustomerGroupBasedCommission($order_info['customer_id'],$salesagent_id);if($customer_group_based_commission){$commission=$customer_group_based_commission;}}$parent_commission=$query['parent_commission'];$second_parent_commission=$query['second_parent_commission'];$checkclist=$this->checkclist($salesagent_id,$order_id,$commission,$parent_commission,$second_parent_commission);if($this->config->get("salesagentdebug_status")){$this->log->write("SalesAgent Checking Total");$this->log->write($total);$this->log->write("SalesAgent Checking CatalogList");$this->log->write($checkclist);}if(empty($checkclist)){$amount=$total*($commission/100.00);$calculationtext=$total." X ".($commission/100.00);}else{$amount=$checkclist['salesagent_comm']+($checkclist['salesagent_comm_nclist']*($commission/100.00));$calculationtext=$checkclist['salesagent_calctext'];}if($this->config->get("salesagentdebug_status")){$this->log->write("SalesAgent CalculationText");$this->log->write($calculationtext);}$products=$this->cart->countProducts();$salesagent_transaction_query=$this->db->query("SELECT * FROM ".DB_PREFIX."salesagent_transaction WHERE order_id = '".(int)$order_id."' AND salesagent_id = '".(int)$salesagent_id."'");if($salesagent_transaction_query->num_rows){$this->db->query("UPDATE ".DB_PREFIX."salesagent_transaction SET salesagent_id = '".(int)$salesagent_id."', name = '".$this->db->escape($salesagent_name)."', customer_id = '".(int)$order_info['customer_id']."', customer_email = '".$this->db->escape($order_info['email'])."', commission = '".$commission."', calculationtext = '".$this->db->escape($calculationtext)."', sub_total = '".(float)$sub_total."',product = '".$products."',amount = '".$amount."', date_added = NOW() WHERE order_id = '".(int)$order_id."'");}else{$this->db->query("INSERT INTO ".DB_PREFIX."salesagent_transaction SET salesagent_id = '".(int)$salesagent_id."', name = '".$this->db->escape($salesagent_name)."', order_id = '".(int)$order_id."', customer_id = '".(int)$order_info['customer_id']."', customer_email = '".$this->db->escape($order_info['email'])."', commission = '".$commission."', calculationtext = '".$this->db->escape($calculationtext)."', sub_total = '".(float)$sub_total."',product = '".$products."',amount = '".$amount."', date_added = NOW()");}$this->db->query("DELETE FROM ".DB_PREFIX."salesagent_order WHERE order_id = '".(int)$order_id."'");$this->db->query("INSERT INTO ".DB_PREFIX."salesagent_order SET salesagent_id = '".(int)$salesagent_id."', order_id = '".(int)$order_id."'");if($query['alertemail']&&$query['email']){$this->session->data['salesagentemail'][0]['salesagent']=$query;$this->session->data['salesagentemail'][0]['order_id']=$order_id;$this->session->data['salesagentemail'][0]['total']=$order_info['total'];$this->session->data['salesagentemail'][0]['commission']=$amount;}if($query['parent_id']){$parent_commission=$query['parent_commission'];$second_parent_commission=$query['second_parent_commission'];$salesagent_id=$query['parent_id'];$query=$this->db->query("SELECT * FROM ".DB_PREFIX."salesagent WHERE salesagent_id = '".(int)$salesagent_id."'")->row;if(isset($query['salesagent_id'])){$salesagent_name=$query['firstname']." ".$query['lastname'];$commission=$parent_commission;if(empty($checkclist)){$amount=$total*($commission/100.00);$calculationtext=$total." X ".($commission/100.00);}else{$amount=$checkclist['parentsalesagent_comm']+($checkclist['parentsalesagent_comm_nclist']*($commission/100.00));$calculationtext=$checkclist['parentsalesagent_calctext'];}$products=$this->cart->countProducts();$salesagent_transaction_query=$this->db->query("SELECT * FROM ".DB_PREFIX."salesagent_transaction WHERE order_id = '".(int)$order_id."' AND salesagent_id = '".(int)$salesagent_id."'");if($salesagent_transaction_query->num_rows){$this->db->query("UPDATE ".DB_PREFIX."salesagent_transaction SET salesagent_id = '".(int)$salesagent_id."', name = '".$this->db->escape($salesagent_name)."', customer_id = '".(int)$order_info['customer_id']."', customer_email = '".$this->db->escape($order_info['email'])."', commission = '".$commission."',calculationtext = '".$this->db->escape($calculationtext)."', sub_total = '".(float)$sub_total."',product = '".$products."',amount = '".$amount."', date_added = NOW() WHERE order_id = '".(int)$order_id."'");}else{$this->db->query("INSERT INTO ".DB_PREFIX."salesagent_transaction SET salesagent_id = '".(int)$salesagent_id."', name = '".$this->db->escape($salesagent_name)."', order_id = '".(int)$order_id."', customer_id = '".(int)$order_info['customer_id']."', customer_email = '".$this->db->escape($order_info['email'])."', commission = '".$commission."',calculationtext = '".$this->db->escape($calculationtext)."', sub_total = '".(float)$sub_total."',product = '".$products."',amount = '".$amount."', date_added = NOW()");}if($query['alertemail']&&$query['email']){$this->session->data['salesagentemail'][1]['salesagent']=$query;$this->session->data['salesagentemail'][1]['order_id']=$order_id;$this->session->data['salesagentemail'][1]['total']=$order_info['total'];$this->session->data['salesagentemail'][1]['commission']=$amount;}}if($query['parent_id']){$parent_commission=$second_parent_commission;$salesagent_id=$query['parent_id'];$query=$this->db->query("SELECT * FROM ".DB_PREFIX."salesagent WHERE salesagent_id = '".(int)$salesagent_id."'")->row;if(isset($query['salesagent_id'])){$salesagent_name=$query['firstname']." ".$query['lastname'];$commission=$parent_commission;if(empty($checkclist)){$amount=$total*($commission/100.00);$calculationtext=$total." X ".($commission/100.00);}else{$amount=$checkclist['mastersalesagent_comm']+($checkclist['mastersalesagent_comm_nclist']*($commission/100.00));$calculationtext=$checkclist['mastersalesagent_calctext'];}$products=$this->cart->countProducts();$salesagent_transaction_query=$this->db->query("SELECT * FROM ".DB_PREFIX."salesagent_transaction WHERE order_id = '".(int)$order_id."' AND salesagent_id = '".(int)$salesagent_id."'");if($salesagent_transaction_query->num_rows){$this->db->query("UPDATE ".DB_PREFIX."salesagent_transaction SET salesagent_id = '".(int)$salesagent_id."', name = '".$this->db->escape($salesagent_name)."', customer_id = '".(int)$order_info['customer_id']."', customer_email = '".$this->db->escape($order_info['email'])."', commission = '".$commission."',calculationtext = '".$this->db->escape($calculationtext)."', sub_total = '".(float)$sub_total."',product = '".$products."',amount = '".$amount."', date_added = NOW() WHERE order_id = '".(int)$order_id."'");}else{$this->db->query("INSERT INTO ".DB_PREFIX."salesagent_transaction SET salesagent_id = '".(int)$salesagent_id."', name = '".$this->db->escape($salesagent_name)."', order_id = '".(int)$order_id."', customer_id = '".(int)$order_info['customer_id']."', customer_email = '".$this->db->escape($order_info['email'])."', commission = '".$commission."',calculationtext = '".$this->db->escape($calculationtext)."', sub_total = '".(float)$sub_total."',product = '".$products."',amount = '".$amount."', date_added = NOW()");}if($query['alertemail']&&$query['email']){$this->session->data['salesagentemail'][2]['salesagent']=$query;$this->session->data['salesagentemail'][2]['order_id']=$order_id;$this->session->data['salesagentemail'][2]['total']=$order_info['total'];$this->session->data['salesagentemail'][2]['commission']=$amount;}}}}}$this->newOrder();}else{$this->db->query("DELETE FROM ".DB_PREFIX."salesagent_transaction WHERE order_id = '".$order_id."'");$this->db->query("DELETE FROM ".DB_PREFIX."salesagent_order WHERE order_id = '".$order_id."'");}}public function newOrder(){if(isset($this->session->data['salesagentemail'])&&!empty($this->session->data['salesagentemail'])){foreach($this->session->data['salesagentemail']as $key=>$data){$this->newOrderEmail($data['salesagent'],$data['order_id'],$data['total'],$data['commission']);}}unset($this->session->data['salesagentemail']);}public function newSignUp($salesagent_id,$firstname,$lastname,$email,$telephone){$query=$this->db->query("SELECT * FROM ".DB_PREFIX."salesagent WHERE salesagent_id = '".(int)$salesagent_id."'");if($query->num_rows&&$query->row['email']&&$query->row['alertemail']){$salesagent_name=$query->row['firstname'];$this->load->language('extension/module/salesagent');$subject=sprintf($this->language->get('text_subject'),html_entity_decode($this->config->get('config_name'),ENT_QUOTES,'UTF-8'));$message=sprintf($this->language->get('text_congrats'),$salesagent_name,html_entity_decode($this->config->get('config_name'),ENT_QUOTES,'UTF-8'))."\n\n";$message.=$this->language->get('text_firstname').' '.$firstname."\n";$message.=$this->language->get('text_lastname').' '.$lastname."\n";$message.=$this->language->get('text_email').' '.$email."\n";$message.=$this->language->get('text_telephone').' '.$telephone."\n";$mail=new Mail($this->config->get('config_mail_engine'));$mail->parameter=$this->config->get('config_mail_parameter');$mail->smtp_hostname=$this->config->get('config_mail_smtp_hostname');$mail->smtp_username=$this->config->get('config_mail_smtp_username');$mail->smtp_password=html_entity_decode($this->config->get('config_mail_smtp_password'),ENT_QUOTES,'UTF-8');$mail->smtp_port=$this->config->get('config_mail_smtp_port');$mail->smtp_timeout=$this->config->get('config_mail_smtp_timeout');$mail->setTo($query->row['email']);$mail->setFrom($this->config->get('config_email'));$mail->setSender(html_entity_decode($this->config->get('config_name'),ENT_QUOTES,'UTF-8'));$mail->setSubject($subject);$mail->setText($message);$mail->send();}}public function newOrderEmail($salesagent_data,$order_id,$total,$commission){$salesagent_name=$salesagent_data['firstname'];$this->load->language('extension/module/salesagent');$subject=sprintf($this->language->get('text_subject_order'),html_entity_decode($this->config->get('config_name'),ENT_QUOTES,'UTF-8'));$message=sprintf($this->language->get('text_congrats_order'),$salesagent_name,html_entity_decode($this->config->get('config_name'),ENT_QUOTES,'UTF-8'))."\n\n";$message.=$this->language->get('text_order_id_salesagent').' '.$order_id."\n";$message.=$this->language->get('text_order_total_salesagent').' '.$this->currency->format($total,$this->session->data['currency'])."\n";$message.=$this->language->get('text_order_commission_salesagent').' '.$this->currency->format($commission,$this->session->data['currency'])."\n";$mail=new Mail($this->config->get('config_mail_engine'));$mail->parameter=$this->config->get('config_mail_parameter');$mail->smtp_hostname=$this->config->get('config_mail_smtp_hostname');$mail->smtp_username=$this->config->get('config_mail_smtp_username');$mail->smtp_password=html_entity_decode($this->config->get('config_mail_smtp_password'),ENT_QUOTES,'UTF-8');$mail->smtp_port=$this->config->get('config_mail_smtp_port');$mail->smtp_timeout=$this->config->get('config_mail_smtp_timeout');$mail->setTo($salesagent_data['email']);$mail->setFrom($this->config->get('config_email'));$mail->setSender(html_entity_decode($this->config->get('config_name'),ENT_QUOTES,'UTF-8'));$mail->setSubject($subject);$mail->setText($message);$mail->send();}public function getSubTotal($order_id){$subtotal_query=$this->db->query("SELECT * FROM ".DB_PREFIX."order_total WHERE order_id = '".(int)$order_id."' AND code = 'sub_total'");if($subtotal_query->num_rows){if($this->config->get("salesagent_coupondiscount")){$coupon_query=$this->db->query("SELECT * FROM ".DB_PREFIX."order_total WHERE order_id = '".(int)$order_id."' AND code = 'coupon'");if($coupon_query->num_rows){$subtotal_query->row['value']+=$coupon_query->row['value'];}}if($this->config->get("salesagent_storecredit")){$credit_query=$this->db->query("SELECT * FROM ".DB_PREFIX."order_total WHERE order_id = '".(int)$order_id."' AND code = 'credit'");if($credit_query->num_rows){$subtotal_query->row['value']+=$credit_query->row['value'];}}return $subtotal_query->row['value'];}else{return 0;}}public function checkclist($salesagent_id,$order_id,$commission,$parent_commission,$second_parent_commission){$returnarray=array();$product_query=$this->db->query("SELECT * FROM ".DB_PREFIX."order_product WHERE order_id = '".(int)$order_id."'");$clist_query=$this->db->query("SELECT * FROM ".DB_PREFIX."salesagent_clist sc LEFT JOIN ".DB_PREFIX."clist c ON (c.clist_id = sc.clist_id) WHERE sc.salesagent_id = '".(int)$salesagent_id."'");if($product_query->num_rows&&$clist_query->rows){$salesagent_comm=0;$parentsalesagent_comm=0;$mastersalesagent_comm=0;$salesagent_comm_nclist=0;$parentsalesagent_comm_nclist=0;$mastersalesagent_comm_nclist=0;$salesagent_calctext="";$parentsalesagent_calctext="";$mastersalesagent_calctext="";foreach($product_query->rows as $key1=>$value1){if($this->config->get("salesagent_commissiontotal")){}else{$value1['total']+=$value1['tax'];}$bit=0;foreach($clist_query->rows as $key=>$value){$categories=json_decode($value['category_id'],true);$products=json_decode($value['product_id'],true);if(is_array($categories)&&!empty($categories)){$actualcategories=$this->getProductCategories($value1['product_id']);if(!empty($actualcategories)){$result=array_intersect($categories,$actualcategories);if(is_array($result)&&!empty($result)){$bit=1;}}}if(!$bit&&is_array($products)&&!empty($products)){if(in_array($value1['product_id'],$products)){$bit=1;}}if($bit){$salesagent_comm=$salesagent_comm+($value1['total']*($value['commission']/100));$parentsalesagent_comm=$parentsalesagent_comm+($value1['total']*($value['parent_commission']/100));$mastersalesagent_comm=$mastersalesagent_comm+($value1['total']*($value['second_parent_commission']/100));$salesagent_calctext.=$value1['name'].": ".$value1['total']." X ".($value['commission']/100)."<br>";$parentsalesagent_calctext.=$value1['name'].": ".$value1['total']." X ".($value['parent_commission']/100)."<br>";$mastersalesagent_calctext.=$value1['name'].": ".$value1['total']." X ".($value['second_parent_commission']/100)."<br>";break;}}if(!$bit){$salesagent_comm_nclist+=$value1['total'];$parentsalesagent_comm_nclist+=$value1['total'];$mastersalesagent_comm_nclist+=$value1['total'];$salesagent_calctext.=$value1['name'].": ".$value1['total']." X ".($commission/100.00)."<br>";$parentsalesagent_calctext.=$value1['name'].": ".$value1['total']." X ".($parent_commission/100)."<br>";$mastersalesagent_calctext.=$value1['name'].": ".$value1['total']." X ".($second_parent_commission/100)."<br>";}}$returnarray['salesagent_comm']=$salesagent_comm;$returnarray['parentsalesagent_comm']=$parentsalesagent_comm;$returnarray['mastersalesagent_comm']=$mastersalesagent_comm;$returnarray['salesagent_comm_nclist']=$salesagent_comm_nclist;$returnarray['parentsalesagent_comm_nclist']=$parentsalesagent_comm_nclist;$returnarray['mastersalesagent_comm_nclist']=$mastersalesagent_comm_nclist;$returnarray['salesagent_calctext']=$salesagent_calctext;$returnarray['parentsalesagent_calctext']=$parentsalesagent_calctext;$returnarray['mastersalesagent_calctext']=$mastersalesagent_calctext;return $returnarray;}else{return $returnarray;}}public function getProductCategories($product_id){$product_category_data=array();$query=$this->db->query("SELECT * FROM ".DB_PREFIX."product_to_category WHERE product_id = '".(int)$product_id."'");foreach($query->rows as $result){$product_category_data[]=$result['category_id'];}return $product_category_data;}public function getAgentName($order_id){$name="";$query=$this->db->query("SELECT st.name FROM ".DB_PREFIX."salesagent_transaction st LEFT JOIN ".DB_PREFIX."salesagent_order o ON (st.salesagent_id = o.salesagent_id) WHERE o.order_id = '".(int)$order_id."' LIMIT 1");if($query->num_rows){$name=ucwords($query->row['name']);}return $name;}public function removeSalesAgent($order_id){$this->db->query("DELETE FROM ".DB_PREFIX."salesagent_transaction WHERE order_id = '".(int)$order_id."'");$this->db->query("DELETE FROM ".DB_PREFIX."salesagent_order WHERE order_id = '".(int)$order_id."'");}public function removeTransactionSession($order_id){$this->db->query("DELETE FROM ".DB_PREFIX."salesagent_temporder WHERE order_id = '".(int)$order_id."'");}public function checkUniqueId($uniqueid){$sql="SELECT * FROM ".DB_PREFIX."salesagent s LEFT JOIN ".DB_PREFIX."salesagent_store ss ON (s.salesagent_id = ss.salesagent_id) WHERE 1 = 1 ";$sql.=" AND s.uniqueid = '".$this->db->escape($uniqueid)."' AND ss.store_id = '".(int)$this->config->get('config_store_id')."' ";$query=$this->db->query($sql);if($query->num_rows){$this->session->data['salesagent_id']=$query->row['salesagent_id'];$this->session->data['uniqueid']=$query->row['uniqueid'];}return $query->row;}public function checkProductIdForSalesAgent($product_id){$bit=$salesagent_id=0;$query=$this->db->query("SELECT * FROM ".DB_PREFIX."salesagent_customer WHERE customerid = '".(int)$this->customer->getId()."' LIMIT 1");if($query->num_rows){if($this->isValidSalesAgent($query->row['salesagent_id'])){$salesagent_id=$query->row['salesagent_id'];}}$clist_query=$this->db->query("SELECT * FROM ".DB_PREFIX."salesagent_clist sc LEFT JOIN ".DB_PREFIX."clist c ON (c.clist_id = sc.clist_id) WHERE sc.salesagent_id = '".(int)$salesagent_id."'");if($salesagent_id&&$clist_query->num_rows){foreach($clist_query->rows as $key=>$value){$categories=json_decode($value['category_id'],true);$products=json_decode($value['product_id'],true);if(is_array($categories)&&!empty($categories)){$actualcategories=$this->getProductCategories($product_id);if(!empty($actualcategories)){$result=array_intersect($categories,$actualcategories);if(is_array($result)&&!empty($result)){$bit=1;break;}}}if(!$bit&&is_array($products)&&!empty($products)){if(in_array($product_id,$products)){$bit=1;break;}}}}return $bit;}public function getAgent($suser_id){$query=$this->db->query("SELECT * FROM ".DB_PREFIX."slogin WHERE suser_id = '".(int)$suser_id."'");return $query->row;}public function getAgentByEmail($email){$query=$this->db->query("SELECT * FROM ".DB_PREFIX."slogin WHERE LOWER(email) = '".$this->db->escape(utf8_strtolower($email))."'");return $query->row;}public function login($username,$password){$slogin_query=$this->db->query("SELECT * FROM ".DB_PREFIX."user WHERE LOWER(username) = '".$this->db->escape(utf8_strtolower($username))."' AND (password = SHA1(CONCAT(salt, SHA1(CONCAT(salt, SHA1('".$this->db->escape($password)."'))))) OR password = '".$this->db->escape(md5($password))."') AND status = '1'");if($slogin_query->num_rows){$this->session->data['suser_id']=$slogin_query->row['user_id'];$salesagent_query=$this->db->query("SELECT salesagent_id FROM ".DB_PREFIX."salesagent WHERE user_id = '".(int)$slogin_query->row['user_id']."'");if($salesagent_query->num_rows){$this->session->data['salesagent_id']=$salesagent_query->row['salesagent_id'];}return true;}else{return false;}}public function logout(){unset($this->session->data['suser_id']);unset($this->session->data['salesagent_id']);}public function isLogged(){if(isset($this->session->data['suser_id'])){return $this->session->data['suser_id'];}else{return 0;}}public function getOrder($order_id){$salesagent_id=$this->user->getSalesAgentId2();$sql="SELECT *  FROM `".DB_PREFIX."order` o LEFT JOIN `".DB_PREFIX."salesagent_transaction` st ON (o.order_id = st.order_id) WHERE o.order_id = '".(int)$order_id."' AND st.salesagent_id IN (".$salesagent_id.") AND o.order_status_id > '0'";if($this->config->get("slogin_orderstatus")){$orderstatusarray=$this->config->get("slogin_orderstatus");if(!empty($orderstatusarray)){$orderstatusstring=implode(",",$orderstatusarray);$sql.=" AND o.order_status_id IN (".$orderstatusstring.")";}}$order_query=$this->db->query($sql);if($order_query->num_rows){$country_query=$this->db->query("SELECT * FROM `".DB_PREFIX."country` WHERE country_id = '".(int)$order_query->row['payment_country_id']."'");if($country_query->num_rows){$payment_iso_code_2=$country_query->row['iso_code_2'];$payment_iso_code_3=$country_query->row['iso_code_3'];}else{$payment_iso_code_2='';$payment_iso_code_3='';}$zone_query=$this->db->query("SELECT * FROM `".DB_PREFIX."zone` WHERE zone_id = '".(int)$order_query->row['payment_zone_id']."'");if($zone_query->num_rows){$payment_zone_code=$zone_query->row['code'];}else{$payment_zone_code='';}$country_query=$this->db->query("SELECT * FROM `".DB_PREFIX."country` WHERE country_id = '".(int)$order_query->row['shipping_country_id']."'");if($country_query->num_rows){$shipping_iso_code_2=$country_query->row['iso_code_2'];$shipping_iso_code_3=$country_query->row['iso_code_3'];}else{$shipping_iso_code_2='';$shipping_iso_code_3='';}$zone_query=$this->db->query("SELECT * FROM `".DB_PREFIX."zone` WHERE zone_id = '".(int)$order_query->row['shipping_zone_id']."'");if($zone_query->num_rows){$shipping_zone_code=$zone_query->row['code'];}else{$shipping_zone_code='';}return array('order_id'=>$order_query->row['order_id'],'invoice_no'=>$order_query->row['invoice_no'],'invoice_prefix'=>$order_query->row['invoice_prefix'],'store_id'=>$order_query->row['store_id'],'store_name'=>$order_query->row['store_name'],'store_url'=>$order_query->row['store_url'],'customer_id'=>$order_query->row['customer_id'],'firstname'=>$order_query->row['firstname'],'lastname'=>$order_query->row['lastname'],'telephone'=>$order_query->row['telephone'],'email'=>$order_query->row['email'],'payment_firstname'=>$order_query->row['payment_firstname'],'payment_lastname'=>$order_query->row['payment_lastname'],'payment_company'=>$order_query->row['payment_company'],'payment_address_1'=>$order_query->row['payment_address_1'],'payment_address_2'=>$order_query->row['payment_address_2'],'payment_postcode'=>$order_query->row['payment_postcode'],'payment_city'=>$order_query->row['payment_city'],'payment_zone_id'=>$order_query->row['payment_zone_id'],'payment_zone'=>$order_query->row['payment_zone'],'payment_zone_code'=>$payment_zone_code,'payment_country_id'=>$order_query->row['payment_country_id'],'payment_country'=>$order_query->row['payment_country'],'payment_iso_code_2'=>$payment_iso_code_2,'payment_iso_code_3'=>$payment_iso_code_3,'payment_address_format'=>$order_query->row['payment_address_format'],'payment_method'=>$order_query->row['payment_method'],'shipping_firstname'=>$order_query->row['shipping_firstname'],'shipping_lastname'=>$order_query->row['shipping_lastname'],'shipping_company'=>$order_query->row['shipping_company'],'shipping_address_1'=>$order_query->row['shipping_address_1'],'shipping_address_2'=>$order_query->row['shipping_address_2'],'shipping_postcode'=>$order_query->row['shipping_postcode'],'shipping_city'=>$order_query->row['shipping_city'],'shipping_zone_id'=>$order_query->row['shipping_zone_id'],'shipping_zone'=>$order_query->row['shipping_zone'],'shipping_zone_code'=>$shipping_zone_code,'shipping_country_id'=>$order_query->row['shipping_country_id'],'shipping_country'=>$order_query->row['shipping_country'],'shipping_iso_code_2'=>$shipping_iso_code_2,'shipping_iso_code_3'=>$shipping_iso_code_3,'shipping_address_format'=>$order_query->row['shipping_address_format'],'shipping_method'=>$order_query->row['shipping_method'],'comment'=>$order_query->row['comment'],'total'=>$order_query->row['total'],'order_status_id'=>$order_query->row['order_status_id'],'language_id'=>$order_query->row['language_id'],'currency_id'=>$order_query->row['currency_id'],'currency_code'=>$order_query->row['currency_code'],'currency_value'=>$order_query->row['currency_value'],'date_modified'=>$order_query->row['date_modified'],'date_added'=>$order_query->row['date_added'],'ip'=>$order_query->row['ip']);}else{return false;}}public function getOrders($data=array()){$sql="SELECT o.order_id, CONCAT(o.firstname, ' ', o.lastname) AS customer, (SELECT os.name FROM ".DB_PREFIX."order_status os WHERE os.order_status_id = o.order_status_id AND os.language_id = '".(int)$this->config->get('config_language_id')."') AS order_status, o.shipping_code, o.total, o.currency_code, o.currency_value, o.date_added, o.date_modified FROM `".DB_PREFIX."order` o";$salesagent_id=$this->user->getSalesAgentId2();if($salesagent_id OR(isset($data['filter_sid'])&&!empty($data['filter_sid']))){$sql.=" INNER JOIN `".DB_PREFIX."salesagent_order` so ON (o.order_id = so.order_id) ";}if(!empty($data['filter_order_status'])){$implode=array();$order_statuses=explode(',',$data['filter_order_status']);foreach($order_statuses as $order_status_id){$implode[]="o.order_status_id = '".(int)$order_status_id."'";}if($implode){$sql.=" WHERE (".implode(" OR ",$implode).")";}}elseif(isset($data['filter_order_status_id'])&&$data['filter_order_status_id']!==''){$sql.=" WHERE o.order_status_id = '".(int)$data['filter_order_status_id']."'";}else{$sql.=" WHERE o.order_status_id > '0'";}if($salesagent_id OR(isset($data['filter_sid'])&&!empty($data['filter_sid']))){if(isset($data['filter_sid'])&&!empty($data['filter_sid'])){$salesagent_id=$data['filter_sid'];}$sql.=" AND  so.salesagent_id IN (".$salesagent_id.") ";}if(!empty($data['filter_order_id'])){$sql.=" AND o.order_id = '".(int)$data['filter_order_id']."'";}if(!empty($data['filter_customer'])){$sql.=" AND CONCAT(o.firstname, ' ', o.lastname) LIKE '%".$this->db->escape($data['filter_customer'])."%'";}if(!empty($data['filter_date_added'])){$sql.=" AND DATE(o.date_added) = DATE('".$this->db->escape($data['filter_date_added'])."')";}if(!empty($data['filter_date_modified'])){$sql.=" AND DATE(o.date_modified) = DATE('".$this->db->escape($data['filter_date_modified'])."')";}if(!empty($data['filter_total'])){$sql.=" AND o.total = '".(float)$data['filter_total']."'";}$sort_data=array('o.order_id','customer','order_status','o.date_added','o.date_modified','o.total');if(isset($data['sort'])&&in_array($data['sort'],$sort_data)){$sql.=" ORDER BY ".$data['sort'];}else{$sql.=" ORDER BY o.order_id";}if(isset($data['order'])&&($data['order']=='DESC')){$sql.=" DESC";}else{$sql.=" ASC";}if(isset($data['start'])||isset($data['limit'])){if($data['start']<0){$data['start']=0;}if($data['limit']<1){$data['limit']=20;}$sql.=" LIMIT ".(int)$data['start'].",".(int)$data['limit'];}$query=$this->db->query($sql);return $query->rows;}public function getTotalOrders($data=array()){$sql="SELECT COUNT(*) AS total FROM `".DB_PREFIX."order` o ";$salesagent_id=$this->user->getSalesAgentId2();if($salesagent_id OR(isset($data['filter_sid'])&&!empty($data['filter_sid']))){$sql.=" INNER JOIN `".DB_PREFIX."salesagent_order` so ON (o.order_id = so.order_id) ";}if(!empty($data['filter_order_status'])){$implode=array();$order_statuses=explode(',',$data['filter_order_status']);foreach($order_statuses as $order_status_id){$implode[]="order_status_id = '".(int)$order_status_id."'";}if($implode){$sql.=" WHERE (".implode(" OR ",$implode).")";}}elseif(isset($data['filter_order_status_id'])&&$data['filter_order_status_id']!==''){$sql.=" WHERE order_status_id = '".(int)$data['filter_order_status_id']."'";}else{$sql.=" WHERE order_status_id > '0'";}if($salesagent_id OR(isset($data['filter_sid'])&&!empty($data['filter_sid']))){if(isset($data['filter_sid'])&&!empty($data['filter_sid'])){$salesagent_id=$data['filter_sid'];}$sql.=" AND  so.salesagent_id IN (".$salesagent_id.") ";}if(!empty($data['filter_order_id'])){$sql.=" AND order_id = '".(int)$data['filter_order_id']."'";}if(!empty($data['filter_customer'])){$sql.=" AND CONCAT(firstname, ' ', lastname) LIKE '%".$this->db->escape($data['filter_customer'])."%'";}if(!empty($data['filter_date_added'])){$sql.=" AND DATE(date_added) = DATE('".$this->db->escape($data['filter_date_added'])."')";}if(!empty($data['filter_date_modified'])){$sql.=" AND DATE(date_modified) = DATE('".$this->db->escape($data['filter_date_modified'])."')";}if(!empty($data['filter_total'])){$sql.=" AND total = '".(float)$data['filter_total']."'";}$query=$this->db->query($sql);return $query->row['total'];}public function getTotalCustomers($data=array()){$sql="SELECT COUNT(c.customer_id) as totalnumber FROM `".DB_PREFIX."customer` c LEFT JOIN `".DB_PREFIX."salesagent_customer` sc ON (c.customer_id = sc.customerid)  LEFT JOIN `".DB_PREFIX."salesagent` s ON (s.salesagent_id = sc.salesagent_id) ";if(!empty($data['filter_salesagent'])){$sql.=" WHERE sc.salesagent_id = '".(int)$data['filter_salesagent']."'";}else{$sql.=" WHERE sc.salesagent_id > '0'";}$salesagent_id=$this->user->getSalesAgentId2();if($salesagent_id){$sql.=" AND sc.salesagent_id  IN  (".$salesagent_id.") ";}$sql.=" AND c.status = 1 ";if(!empty($data['filter_date_start'])){$sql.=" AND DATE(c.date_added) >= DATE('".$this->db->escape($data['filter_date_start'])."') ";}if(!empty($data['filter_date_end'])){$sql.=" AND DATE(c.date_added) <= DATE('".$this->db->escape($data['filter_date_end'])."') ";}$query=$this->db->query($sql);return $query->row['totalnumber'];}public function getCustomers($data=array()){$sql="SELECT CONCAT(s.firstname, ' ', s.lastname) AS name,c.customer_id,c.telephone,c.firstname,c.lastname,c.email,c.date_added FROM `".DB_PREFIX."customer` c LEFT JOIN `".DB_PREFIX."salesagent_customer` sc ON (c.customer_id = sc.customerid) LEFT JOIN `".DB_PREFIX."salesagent` s ON (s.salesagent_id = sc.salesagent_id) ";if(!empty($data['filter_salesagent'])){$sql.=" WHERE sc.salesagent_id = '".(int)$data['filter_salesagent']."'";}else{$sql.=" WHERE sc.salesagent_id > '0'";}$salesagent_id=$this->user->getSalesAgentId2();if($salesagent_id){$sql.=" AND sc.salesagent_id  IN  (".$salesagent_id.") ";}$sql.=" AND c.status = 1 ";if(!empty($data['filter_date_start'])){$sql.=" AND DATE(c.date_added) >= DATE('".$this->db->escape($data['filter_date_start'])."') ";}if(!empty($data['filter_date_end'])){$sql.=" AND DATE(c.date_added) <= DATE('".$this->db->escape($data['filter_date_end'])."') ";}$sql.=" ORDER BY c.date_added DESC";if(isset($data['start'])||isset($data['limit'])){if($data['start']<0){$data['start']=0;}if($data['limit']<1){$data['limit']=20;}$sql.=" LIMIT ".(int)$data['start'].",".(int)$data['limit'];}$query=$this->db->query($sql);return $query->rows;}public function editToken($customer_id,$token){$this->db->query("UPDATE ".DB_PREFIX."customer SET token = '".$this->db->escape($token)."' WHERE customer_id = '".(int)$customer_id."'");}public function getStore($store_id){$query=$this->db->query("SELECT DISTINCT * FROM ".DB_PREFIX."store WHERE store_id = '".(int)$store_id."'");return $query->row;}public function getCustomerGroupBasedCommission($customer_id=0,$salesagent_id=0){$returnvalue=0;$query=$this->db->query("SELECT customer_group_id FROM ".DB_PREFIX."customer WHERE customer_id = '".(int)$customer_id."'");if($query->num_rows){$commissionquery=$this->db->query("SELECT commission FROM ".DB_PREFIX."salesagent_customer_group WHERE salesagent_id = '".(int)$salesagent_id."' AND customer_group_id = '".(int)$query->row['customer_group_id']."'");if($commissionquery->num_rows){$returnvalue=$commissionquery->row['commission'];}}return $returnvalue;}}